<script>

  var gcpSelectedList = {};
  var gcpDisabled = false;
  const GCP_GROUP_SELECTION_LIMIT = 20;

  function clearGCPGroups() {
    removeAllGCPGroups();
    gcpSelectedList = {};
  }

  const handleGCPGroupSelectionCheckbox = (elem) => {
    $(elem).prop('checked', !$(elem).prop('checked'));
  }

  const handleGCPGroupSelectionView = () => {
    let finalCount = $('#gcp-group-selection-table').children('tr').length;
    if(gcpDisabled) {
      finalCount = 'All';
    }

    if(finalCount < 1) {
      $('#gcp-group-selection-empty').show();
      $('#gcp-group-selection-list').hide();
      $('#gcp-group-selection-list').children('nav').hide();
      $('#gcp-group-selected-count').hide();
    } else {
      $('#gcp-group-selection-empty').hide();
      $('#gcp-group-selection-list').show();
      $('#gcp-group-selection-list').children('nav').css('display', 'flex');
      $('#gcp-group-selected-count').show();
      $('#gcp-group-selected-count').text(finalCount + ' selected');
    }
  };

  const selectGCPGroupCheckbox = (elem, checked) => {
    if(checked) {
      $(elem).find('input').prop('checked', true);
      $(elem).removeClass('hover:bg-blue-50 hover:text-blue-700').addClass('bg-gray-50');
      $(elem).children('td#gcp-description-td').removeClass('text-gray-900').addClass('text-blue-600');
    } else {
      $(elem).find('input').prop('checked', false);
      $(elem).removeClass('bg-gray-50').addClass('hover:bg-blue-50 hover:text-blue-700');
      $(elem).children('td#gcp-description-td').removeClass('text-blue-600').addClass('text-gray-900');
    }
  };

  const gcpHandleDisableMode = () => {
    gcpSelectedList = {};
    const groups = $('#gcp-group-table').children('tr');
    for(iter = 0; iter < groups.length; iter++) {
      if (gcpDisabled) {
        $(groups[iter]).find('input').prop('checked', true);
        $(groups[iter]).removeAttr("onclick");
        $(groups[iter]).find('input').attr("disabled", true);
        $(groups[iter]).removeClass('hover:bg-blue-50 hover:text-blue-700').addClass('bg-gray-50');
        $(groups[iter]).children('td#gcp-description-td').removeClass('text-gray-900').addClass('text-blue-600');
      } else {
        $(groups[iter]).attr("onclick", "handleGCPGroupSelection(this)");
        $(groups[iter]).find('input').attr("disabled", false);
        $(groups[iter]).find('input').prop('checked', false);
        $(groups[iter]).removeClass('bg-gray-50').addClass('hover:bg-blue-50 hover:text-blue-700');
        $(groups[iter]).children('td#gcp-description-td').removeClass('text-blue-600').addClass('text-gray-900');
      }
    }
  };

  const addGCPGroupSelection= (elem) => {
    const selectionList = $('#gcp-group-selection-table');
    const newSpan = $("#gcp-group-selection-row-template").clone(true, true);

    selectGCPGroupCheckbox(elem, true);
    const group = $(elem).attr("group");

    newSpan.appendTo(selectionList);
    newSpan.show();
    const tableData = newSpan.children('td');
    tableData[0].textContent = group;
    newSpan.attr('group', group);

    gcpSelectedList[group] = true;
    handleGCPGroupSelectionView();
  };

  const removeGcpGroupSelectionSpanElem = (rightElem, leftElem) => {
    rightElem.remove();
    selectGCPGroupCheckbox(leftElem, false);

    gcpSelectedList[$(leftElem).attr("group") || $(rightElem).attr("group")] = false;
    handleGCPGroupSelectionView();
  };

  const removeAllGCPGroups = (disabledState) => {
    gcpDisabled = disabledState;
    const groups = $('#gcp-group-selection-table').children('tr');

    for(iter = 0; iter < groups.length; iter++) {
      if($(groups[iter]).attr('selectAll')) {
        $(groups[iter]).remove();
        $("#selectAllGCPGroup").prop("checked", false);
      } else {
        removeGcpGroupSelectionSpanElem(groups[iter], $("#gcp-group-table").find(`tr[group="${$(groups[iter]).attr('group')}"]`));
      }
    }
    gcpHandleDisableMode();
    updateSelectedGCPGroup();
    handleGCPGroupSelectionView();
    $('#max-gcp-group-selected-warning').hide();
  };

  const selectAllGCPGroup = () => {
    removeAllGCPGroups(true);
    const selectionList = $('#gcp-group-selection-table');
    const newSpan = $("#gcp-group-selection-row-template").clone(true, true);
    newSpan.appendTo(selectionList);
    newSpan.show();
    const tableData = newSpan.children('td');
    tableData[0].textContent = "All Groups Selected";
    newSpan.attr("selectAll", true);
    updateSelectedGCPGroup();
  }

  const selectAllGCPGroupToggle = (elem) => {
    if(elem.checked) {
      selectAllGCPGroup();
    } else {
      removeAllGCPGroups(false);
    }
    handleGCPGroupSelectionView();
  }

  const removeGCPGroupSelection = (elem) => {
    $("#selectAllGCPGroup").prop("checked", false);
    removeGcpGroupSelectionSpanElem($("#gcp-group-selection-table").find(`tr[group="${$(elem).attr('group')}"]`),elem);
  };

  const removeGCPGroupSelectionUI = (elem) => {
    rightElem = elem.parentElement.parentElement;
    if($(rightElem).attr("selectAll")) {
      $("#selectAllGCPGroup").prop("checked", false);
      gcpDisabled = false;
      gcpHandleDisableMode();
      $(rightElem).remove();
      handleGCPGroupSelectionView();
    } else {
      removeGcpGroupSelectionSpanElem(rightElem, $("#gcp-group-table").find(`tr[group="${$(rightElem).attr('group')}"]`));
    }
    updateSelectedGCPGroup();
    $('#max-gcp-group-selected-warning').hide();
  };

  const findGcpSelectedListLength = () => {
    let count = 0;
    Object.values(gcpSelectedList).forEach(val => {
      if(val) count++;
    })
    return count;
  }

  const handleGCPGroupSelection = (elem) => {
    if(gcpDisabled) return;
    if(!$(elem).find('input').prop('checked')) {
      if(findGcpSelectedListLength() === GCP_GROUP_SELECTION_LIMIT) {
        $('#max-gcp-group-selected-warning').show();
        return;
      }
      addGCPGroupSelection(elem);
    } else {
      removeGCPGroupSelection(elem);
    }
    updateSelectedGCPGroup();
    if(findGcpSelectedListLength() === GCP_GROUP_SELECTION_LIMIT) {
      $('#max-gcp-group-selected-warning').show();
    } else {
      $('#max-gcp-group-selected-warning').hide();
    }
  };

  function updateSelectedGCPGroup() {
    const gcp_groups = $('#gcp-group-selection-table').children('tr');
    const groups = [];
    for(iter = 0; iter < gcp_groups.length; iter++) {
      groups.push($(gcp_groups[iter]).attr("group"));
    }

    $('#selected-gcp-groups').val(JSON.stringify(groups));
  }

  function getSelectedgcpDomain() {
    return $('#gcpDomain').val();
  }

  const gcpGroupPageChange = (page) => {
    if(page !== 'None'){
      fetchGCPGroups(get_gcp_group_search_val(), Number(page));
    }
  }

  function searchGCPGroup(event, elem) {
    if(event.key === "Enter") {
      fetchGCPGroups($(elem).val(), undefined);
    }
  }

  function get_gcp_group_search_val() {
    return $("#gcpSearch").val();
  }

  function showGCPGroups(){
     clearGCPGroups();
     fetchGCPGroups();
   }

  function fetchGCPGroups(search=undefined, page=undefined) {
    $('#gcpDomain').prop("disabled",true);
    $('#gcpSearch').prop("disabled", true);
    $("#selectAllGCPGroup").prop("disabled", true);

    let GCPDomain = getSelectedgcpDomain();

    $.ajax({
      url: "/api/v1/gcp/domain/groups",
      data: {"gcp_domain": GCPDomain, "search": search, "page": page},
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        if(XMLHttpRequest.responseJSON) {
          const msg = XMLHttpRequest.responseJSON;
          showNotification("failed", msg["error"]);
        }
         $('#gcpDomain').prop("disabled",false);
         $('#gcpSearch').prop("disabled", false);
         $("#selectAllGCPGroup").prop("disabled", false);
       }
    }).done(function(data, statusText, xhr){
      $("#gcp-group-table").empty();
      if(data["search_error"]) {
        showNotification("failed", data["search_error"], "No exact match found");
      }

      if(data["gcp_groups"] && data["gcp_groups"].length === 0) return;

      let rows = $.map(data["gcp_groups"], function(group, idx){
        return `<tr onclick="handleGCPGroupSelection(this)" class="${(gcpSelectedList[group] || gcpDisabled)? "bg-gray-50": "hover:bg-blue-50 hover:text-blue-700"}" group="${group}">
            <td class="relative w-12 px-6 sm:w-16 sm:px-8">
              <input type="checkbox" id="gcp-checkbox-td" class="absolute left-4 top-1/2 -mt-2 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600 sm:left-6" onclick="handleGCPGroupSelectionCheckbox(this)" ${ (gcpSelectedList[group] || gcpDisabled)? "checked": ""}></input>
            </td>
            <td class="whitespace-nowrap py-4 pr-3 text-sm font-medium ${gcpSelectedList[group]? "text-blue-600" : "text-gray-900"}" id="gcp-description-td">${group}</td>
          </tr>`
      });

      if(data["next_page"]) {
        $("#gcpPaginationNav").removeClass("hidden");
        $("#gcp_next_page").attr("onclick", `gcpGroupPageChange('${data["next_page"]}')`);
      } else {
        $("#gcpPaginationNav").removeClass("hidden");
        $("#gcp_next_page").attr("onclick", `gcpGroupPageChange('None')`);
      }

      if(data["prev_page"]) {
        $("#gcpPaginationNav").removeClass("hidden");
        $("#gcp_prev_page").attr("onclick", `gcpGroupPageChange('${data["prev_page"]}')`);
      } else {
        $("#gcpPaginationNav").removeClass("hidden");
        $("#gcp_prev_page").attr("onclick", `gcpGroupPageChange('None')`);
      }

      $("#gcpGroupsScrollBar").scrollTop(0);

      $('#gcp-group-table').append(rows.join(""));
      $('#gcpDomain').prop("disabled", false);
      $('#gcpSearch').prop("disabled", false);
      $("#selectAllGCPGroup").prop("disabled", false);
    })
  }
</script>
{% load reusable_components %}

<div class="pt-4">
  <label for="gcpDomain" class="text-sm font-medium leading-5 text-gray-700">GCP Domain</label>
  <div class="mt-2">
    <select onchange="showGCPGroups()" id="gcpDomain" name="gcp-domain" class="w-[460px] rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"required>
      <option hidden disabled selected value="">Select</option>
      {% for each_account in each_access.accessRequestData.domains %}
      <option value="{{ each_account }}">{{ each_account }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<div id="max-gcp-group-selected-warning" class="hidden">
  {% get_error_panel_with_message "Max number of GCP groups selected" "Deselect some selections or Submit request to select more groups." %}
</div>

<h1 class="pt-5 text-sm text-gray-900">GCP groups that you should be a part of</h1>
<div class="grid grid-cols-2 gap-4">
  <div class="flex-col">
    <div class="mt-4 flex flex-col">
      <div class="flex felx-row">
        <div class="flex-auto relative flex items-center">
          <input disabled type="text" name="gcpSearch" id="gcpSearch" class="block w-full rounded-md border-gray-300 pr-12 shadow-sm focus:border-blue-600 focus:ring-blue-600 sm:text-sm" placeholder="Search GCP groups" onkeydown="searchGCPGroup(event, this)">
          <div class="absolute inset-y-0 right-0 flex py-1.5 pr-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" class="text-gray-500 h-full" width="18px" fill="currentColor" aria-hidden="true">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
          </div>
        </div>
        <div class="flex-none flex">
          <input disabled type="checkbox" onclick="selectAllGCPGroupToggle(this)" name="select-all-gcp-groups" id="selectAllGCPGroup" class="ml-4 mr-2 mt-2 px-1 py-1 top-1/2 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600 sm:left-6">
          <label class="ml-1 mr-3 mt-1 mb-2.5 text-base leading-6 font-normal text-gray-900">Select all</label>
        </div>
      </div>
      <div id="gcpGroupsScrollBar" class="h-80 ml-1 overflow-y-auto bg-white mt-6 rounded-md border-0 ring-1 ring-gray-200">
        <div class="px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col">
            <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
              <div class="inline-block min-w-full align-middle">
                <div class="relative overflow-hidden">
                  <table class="min-w-full table-fixed">
                    <tbody class="bg-white" id="gcp-group-table">

                    </tbody>
                  </table>
                  <nav id="gcpPaginationNav"
                    class="hidden flex flex-shrink-0 px-4 items-center rounded-b-lg justify-between align-bottom border-t border-gray-200 bg-white pt-4 pb-4 sticky">
                    <button type="button" id="gcp_prev_page"
                      class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 sticky">
                      <svg xmlns="http://www.w3.org/2000/svg" class="rotate-180 fill-gray-400 mr-4" height="20" viewBox="0 -960 960 960" width="20">
                        <path d="m691-265-68-67 100-100H103v-94h621L623-626l67-67 214 214-213 214Z"/>
                      </svg>
                      Previous
                    </button>
                    <button type="button" id="gcp_next_page"
                      class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 sticky">
                      Next
                      <svg xmlns="http://www.w3.org/2000/svg" class="fill-gray-400 ml-4" height="20" viewBox="0 -960 960 960" width="20">
                        <path d="m691-265-68-67 100-100H103v-94h621L623-626l67-67 214 214-213 214Z"/>
                      </svg>
                    </button>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="mt-3 ml-2 flex flex-col">
    <div class="flex flex-row items-center mb-10">
      <h1 class="text-xl text-gray-900">Your selection</h1>
      <span class="inline-flex items-center rounded-full bg-green-100 ml-4 px-2.5 py-0.5 text-xs font-medium text-green-800 hidden" id="gcp-group-selected-count">0 selected</span>
    </div>
    <div class="rounded-md border-0 ring-1 ring-inset ring-gray-200 py-24 px-6 sm:py-32 bg-white justify-center lg:px-8 flex h-80" id="gcp-group-selection-empty">
      <div class="mx-auto max-w-2xl">
        <div class="flex gap-4 content-center justify-center min-w-full min-h-full">
          <div class="block m-auto content-center justify-center">
            <div class="m-auto content-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 96 960 960" width="40px" class="text-gray-400 flex-shrink-0 justify-center content-center block m-auto" fill="currentColor" aria-hidden="true">
                  <path d="M479.754 801Q504 801 519.5 786.246q15.5-14.755 15.5-39Q535 723 519.746 707q-15.255-16-39.5-16Q456 691 440.5 706.982 425 722.965 425 747.211q0 24.245 15.254 39.017Q455.509 801 479.754 801ZM436 624h94V354h-94v270Zm44.404 377q-88.872 0-166.125-33.084-77.254-33.083-135.183-91.012-57.929-57.929-91.012-135.119Q55 664.594 55 575.638q0-88.957 33.084-166.285 33.083-77.328 90.855-134.809 57.772-57.482 135.036-91.013Q391.238 150 480.279 150q89.04 0 166.486 33.454 77.446 33.453 134.853 90.802 57.407 57.349 90.895 134.877Q906 486.66 906 575.734q0 89.01-33.531 166.247-33.531 77.237-91.013 134.86-57.481 57.623-134.831 90.891Q569.276 1001 480.404 1001Zm.096-94q137.5 0 234-96.372T811 575.5q0-137.5-96.312-234Q618.375 245 479.5 245q-137.5 0-234 96.312Q149 437.625 149 576.5q0 137.5 96.372 234T480.5 907Zm-.5-331Z"/>
                </svg>
            </div>
            <h4 class="text-sm[14px] leading-5 font-medium tracking-tight text-center text-gray-900 sm:text-lg mt-2">You have not selected any groups yet</h4>
            <p class="mt-2 text-sm[14px] leading-5 font-normal text-center text-gray-700">Please select GCP groups from the left panel.</p>
          </div>
        </div>
      </div>
    </div>
    <div class="h-80 w-full bg-white flex flex-col justify-center md:flex-col rounded-md border-0 ring-1 ring-inset ring-gray-200 md:flex hidden" style="display: none;" id="gcp-group-selection-list">
      <div class="flex-1 relative overflow-y-auto space-y-1 inline-block rounded-md min-w-full align-middle">
          <table class="min-w-full border-l border-t border-r table-fixed rounded-md divide-gray-300">
            <tbody class="divide-gray-200 bg-white" id="gcp-group-selection-table">
            </tbody>
          </table>
      </div>
      <nav class="flex flex-shrink-0 px-4 items-center justify-between align-bottom border-t border-gray-200 pt-4 pb-4 hidden">
        <button type="button" class="inline-flex items-center rounded-md border border-transparent bg-blue-100 px-4 py-2 text-base font-medium text-blue-700 shadow-sm hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2" onclick="removeAllGCPGroups(false);">
          Remove all
        </button>
      </nav>
    </div>
  </div>
</div>
<table class="hidden">
<tr id="gcp-group-selection-row-template" class="hidden max-h-4 px-6 hover:bg-blue-50 hover:text-blue-700">
  <td class="relative w-full px-4" id="gcp-group-selection-row-tabledesc">Group</td>
  <td class="whitespace-nowrap px-4 py-4 text-sm font-medium text-gray-900 justify-right content-right max-w-2" id="gcp-group-selection-row-cancel">
    <button type="button" class="ml-0.5 mr-0.5 inline-flex max-w-2 flex-shrink-0 items-center justify-center rounded-full text-blue-400 hover:bg-blue-200 hover:text-blue-500 focus:bg-blue-500 focus:text-white focus:outline-none" onclick="removeGCPGroupSelectionUI(this);">
      <span class="sr-only">Remove large option</span>
      <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
        <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
      </svg>
    </button>
  </td>
</tr>
</table>

<input type="hidden" id="selected-gcp-groups" value="[]" name="selected-gcp-groups">
